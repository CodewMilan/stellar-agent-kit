{"version":3,"sources":["../src/agent.ts","../src/config/networks.ts","../src/dex/soroSwap.ts","../src/dex/index.ts","../src/config/assets.ts"],"sourcesContent":["/**\n * StellarAgentKit – unified DeFi agent (MNTAgentKit-style API for Stellar).\n * Constructor(secretKey, network) + initialize() then protocol methods.\n */\n\nimport { Keypair, Asset, TransactionBuilder, Operation, Networks, Horizon } from \"@stellar/stellar-sdk\";\nimport { getNetworkConfig, type NetworkConfig } from \"./config/networks.js\";\nimport { createDexClient, type DexAsset, type QuoteResult, type SwapResult } from \"./dex/index.js\";\n\nexport type StellarNetwork = \"mainnet\" | \"testnet\";\n\nexport class StellarAgentKit {\n  public readonly keypair: Keypair;\n  public readonly network: StellarNetwork;\n  public readonly config: NetworkConfig;\n  private _initialized = false;\n  private _dex: ReturnType<typeof createDexClient> | null = null;\n  private _horizon: Horizon.Server | null = null;\n\n  constructor(secretKey: string, network: StellarNetwork) {\n    this.keypair = Keypair.fromSecret(secretKey.trim());\n    this.network = network;\n    this.config = getNetworkConfig(network);\n  }\n\n  /**\n   * Initialize clients (Horizon, Soroban RPC, protocol wrappers).\n   * Call after construction before using protocol methods.\n   */\n  async initialize(): Promise<this> {\n    this._horizon = new Horizon.Server(this.config.horizonUrl);\n    this._dex = createDexClient(this.config, process.env.SOROSWAP_API_KEY);\n    this._initialized = true;\n    return this;\n  }\n\n  private ensureInitialized(): void {\n    if (!this._initialized || !this._dex) {\n      throw new Error(\"StellarAgentKit not initialized. Call await agent.initialize() first.\");\n    }\n  }\n\n  // ─── DEX Operations (mirror Mantle agniSwap / executeSwap) ─────────────────\n\n  /**\n   * Get a swap quote (exact-in). Uses SoroSwap aggregator (SoroSwap, Phoenix, Aqua).\n   */\n  async dexGetQuote(\n    fromAsset: DexAsset,\n    toAsset: DexAsset,\n    amount: string\n  ): Promise<QuoteResult> {\n    this.ensureInitialized();\n    return this._dex!.getQuote(fromAsset, toAsset, amount);\n  }\n\n  /**\n   * Execute a swap using a prior quote.\n   */\n  async dexSwap(quote: QuoteResult): Promise<SwapResult> {\n    this.ensureInitialized();\n    return this._dex!.executeSwap(this.keypair.secret(), quote);\n  }\n\n  /**\n   * One-shot: get quote and execute swap (convenience).\n   */\n  async dexSwapExactIn(\n    fromAsset: DexAsset,\n    toAsset: DexAsset,\n    amount: string\n  ): Promise<SwapResult> {\n    const quote = await this.dexGetQuote(fromAsset, toAsset, amount);\n    return this.dexSwap(quote);\n  }\n\n  // ─── Payments (Horizon) ────────────────────────────────────────────────────\n\n  /**\n   * Send a native or custom-asset payment (Horizon).\n   * @param to - Destination account (G...)\n   * @param amount - Amount in display units (e.g. \"10\" for 10 XLM)\n   * @param assetCode - Optional; omit for native XLM\n   * @param assetIssuer - Optional; required if assetCode is set\n   */\n  async sendPayment(\n    to: string,\n    amount: string,\n    assetCode?: string,\n    assetIssuer?: string\n  ): Promise<{ hash: string }> {\n    this.ensureInitialized();\n    if (!this._horizon) throw new Error(\"Horizon not initialized\");\n\n    const networkPassphrase =\n      this.network === \"testnet\" ? Networks.TESTNET : Networks.PUBLIC;\n    const sourceAccount = await this._horizon.loadAccount(this.keypair.publicKey());\n\n    const asset =\n      assetCode && assetIssuer\n        ? new Asset(assetCode, assetIssuer)\n        : Asset.native();\n\n    const tx = new TransactionBuilder(sourceAccount, {\n      fee: \"100\",\n      networkPassphrase,\n    })\n      .addOperation(Operation.payment({ destination: to, asset, amount }))\n      .setTimeout(180)\n      .build();\n\n    tx.sign(this.keypair);\n    const result = await this._horizon.submitTransaction(tx);\n    return { hash: result.hash };\n  }\n\n  // ─── Placeholders for lending / oracle / cross-chain (plug later) ────────────\n\n  // async lendingSupply(asset: DexAsset, amount: string): Promise<{ hash: string }> { ... }\n  // async lendingBorrow(asset: DexAsset, amount: string): Promise<{ hash: string }> { ... }\n  // async getPrice(assetOrFeedId: string): Promise<{ price: string }> { ... }\n  // async crossChainSwap(...): Promise<SwapResult> { ... }\n}\n","import { z } from \"zod\";\n\nexport const NetworkConfigSchema = z.object({\n  horizonUrl: z.string().url(),\n  sorobanRpcUrl: z.string().url(),\n  friendbotUrl: z.string().url().optional(),\n});\n\nexport type NetworkConfig = z.infer<typeof NetworkConfigSchema>;\n\nexport const testnet: NetworkConfig = {\n  horizonUrl: \"https://horizon-testnet.stellar.org\",\n  sorobanRpcUrl: \"https://soroban-testnet.stellar.org\",\n  friendbotUrl: \"https://friendbot.stellar.org\",\n};\n\nexport const mainnet: NetworkConfig = {\n  horizonUrl: \"https://horizon.stellar.org\",\n  sorobanRpcUrl: \"https://soroban-rpc.mainnet.stellar.gateway.fm\",\n};\n\nexport const networks = { testnet, mainnet } as const;\nexport type NetworkName = keyof typeof networks;\n\nexport function getNetworkConfig(name: string): NetworkConfig {\n  const parsed = z.enum([\"testnet\", \"mainnet\"]).safeParse(name);\n  if (!parsed.success) throw new Error(`Invalid network: ${name}. Use \"testnet\" or \"mainnet\".`);\n  return networks[parsed.data];\n}\n","/**\n * SoroSwap DEX client – quote via API, build + sign + submit for executeSwap.\n */\n\nimport { Keypair, TransactionBuilder, Networks } from \"@stellar/stellar-sdk\";\nimport { rpc } from \"@stellar/stellar-sdk\";\nimport type { NetworkConfig } from \"../config/networks.js\";\nimport { getNetworkConfig, type NetworkName } from \"../config/networks.js\";\nimport type { DexAsset, QuoteResult, SwapResult } from \"./types.js\";\n\nconst SOROSWAP_API_BASE = \"https://api.soroswap.finance\";\n\nfunction assetToApiString(asset: DexAsset): string {\n  if (asset.contractId) return asset.contractId;\n  if (asset.code && asset.issuer) return `${asset.code}:${asset.issuer}`;\n  throw new Error(\"Asset must have contractId or code+issuer\");\n}\n\nfunction parseApiQuote(data: unknown): QuoteResult {\n  const o = data as Record<string, unknown>;\n  return {\n    expectedIn: String(o?.expectedIn ?? o?.amountIn ?? \"0\"),\n    expectedOut: String(o?.expectedOut ?? o?.amountOut ?? \"0\"),\n    minOut: String(o?.minOut ?? o?.minimumAmountOut ?? o?.expectedOut ?? \"0\"),\n    route: Array.isArray(o?.route) ? (o.route as string[]) : Array.isArray(o?.path) ? (o.path as string[]) : [],\n    rawData: data,\n  };\n}\n\nexport function createSoroSwapDexClient(\n  networkConfig: NetworkConfig,\n  apiKey?: string\n): { getQuote: (from: DexAsset, to: DexAsset, amount: string) => Promise<QuoteResult>; executeSwap: (secretKey: string, quote: QuoteResult) => Promise<SwapResult> } {\n  const networkName: NetworkName = networkConfig.horizonUrl.includes(\"testnet\") ? \"testnet\" : \"mainnet\";\n  const key = apiKey ?? process.env.SOROSWAP_API_KEY;\n\n  async function getQuote(from: DexAsset, to: DexAsset, amount: string): Promise<QuoteResult> {\n    const url = `${SOROSWAP_API_BASE}/quote?network=${networkName}`;\n    const body = {\n      assetIn: assetToApiString(from),\n      assetOut: assetToApiString(to),\n      amount: String(amount).trim(),\n      tradeType: \"EXACT_IN\",\n      protocols: [\"soroswap\", \"phoenix\", \"aqua\"],\n    };\n    const headers: Record<string, string> = { \"Content-Type\": \"application/json\" };\n    if (key) headers[\"Authorization\"] = `Bearer ${key}`;\n    const res = await fetch(url, { method: \"POST\", headers, body: JSON.stringify(body) });\n    if (!res.ok) {\n      const text = await res.text();\n      throw new Error(`SoroSwap quote failed ${res.status}: ${text}`);\n    }\n    return parseApiQuote(await res.json());\n  }\n\n  async function executeSwap(secretKey: string, quote: QuoteResult): Promise<SwapResult> {\n    if (!key) throw new Error(\"executeSwap requires SOROSWAP_API_KEY\");\n    const keypair = Keypair.fromSecret(secretKey.trim());\n    const fromAddress = keypair.publicKey();\n    const buildUrl = `${SOROSWAP_API_BASE}/quote/build?network=${networkName}`;\n    const buildRes = await fetch(buildUrl, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\", Authorization: `Bearer ${key}` },\n      body: JSON.stringify({ quote: quote.rawData ?? quote, from: fromAddress, to: fromAddress }),\n    });\n    if (!buildRes.ok) throw new Error(`SoroSwap build failed ${buildRes.status}: ${await buildRes.text()}`);\n    const buildData = (await buildRes.json()) as { xdr?: string };\n    const xdrBase64 = buildData?.xdr;\n    if (!xdrBase64 || typeof xdrBase64 !== \"string\") throw new Error(\"SoroSwap build response missing xdr\");\n    const config = getNetworkConfig(networkName);\n    const networkPassphrase = config.horizonUrl.includes(\"testnet\") ? Networks.TESTNET : Networks.PUBLIC;\n    const tx = TransactionBuilder.fromXDR(xdrBase64, networkPassphrase);\n    tx.sign(keypair);\n    const server = new rpc.Server(config.sorobanRpcUrl, { allowHttp: config.sorobanRpcUrl.startsWith(\"http:\") });\n    const sendResult = await server.sendTransaction(tx);\n    if (sendResult.errorResult) throw new Error(`Soroban sendTransaction failed: ${String(sendResult.errorResult)}`);\n    return { hash: sendResult.hash, status: sendResult.status ?? \"PENDING\" };\n  }\n\n  return { getQuote, executeSwap };\n}\n","/**\n * DEX module – swap, quote, aggregator (SoroSwap).\n * Pluggable: add more DEXes by implementing DexClient.\n */\n\nimport type { NetworkConfig } from \"../config/networks.js\";\nimport type { DexAsset, QuoteResult, SwapResult } from \"./types.js\";\nimport { createSoroSwapDexClient } from \"./soroSwap.js\";\n\nexport type { DexAsset, QuoteResult, SwapResult } from \"./types.js\";\nexport { createSoroSwapDexClient } from \"./soroSwap.js\";\n\nexport interface DexClient {\n  getQuote(fromAsset: DexAsset, toAsset: DexAsset, amount: string): Promise<QuoteResult>;\n  executeSwap(secretKey: string, quote: QuoteResult): Promise<SwapResult>;\n}\n\n/**\n * Build a DEX client for the given network (SoroSwap aggregator).\n */\nexport function createDexClient(networkConfig: NetworkConfig, apiKey?: string): DexClient {\n  return createSoroSwapDexClient(networkConfig, apiKey);\n}\n","/**\n * Stellar asset identifiers and contract addresses.\n * Centralized for mainnet/testnet (mirrors Mantle DevKit \"Token Addresses\").\n */\n\nexport type StellarAsset = { code: string; issuer: string } | { contractId: string };\n\nexport const TESTNET_ASSETS = {\n  XLM: { contractId: \"CDLZFC3SYJYDZT7K67VZ75HPJVIEUVNIXF47ZG2FB2RMQQVU2HHGCYSC\" },\n  USDC: { contractId: \"CBBHRKEP5M3NUDRISGLJKGHDHX3DA2CN2AZBQY6WLVUJ7VNLGSKBDUCM\" },\n  /** Classic testnet USDC */\n  AUSDC: { code: \"AUSDC\", issuer: \"GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN\" },\n} as const;\n\nexport const MAINNET_ASSETS = {\n  XLM: { contractId: \"CAS3J7GYLGXMF6TDJBBYYSE3HQ6BBSMLNUQ34T6TZMYMW2EVH34XOWMA\" },\n  USDC: { contractId: \"CCW67TSZV3SSS2HXMBQ5JFGCKJNXKZM7UQUWUZPUTHXSTZLEO7SJMI75\" },\n} as const;\n\nexport const SOROSWAP_AGGREGATOR = {\n  testnet: \"CCJUD55AG6W5HAI5LRVNKAE5WDP5XGZBUDS5WNTIVDU7O264UZZE7BRD\",\n  mainnet: \"CAG5LRYQ5JVEUI5TEID72EYOVX44TTUJT5BQR2J6J77FH65PCCFAJDDH\",\n} as const;\n"],"mappings":"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","names":["Keypair","TransactionBuilder","Networks","Keypair","Networks","TransactionBuilder"]}